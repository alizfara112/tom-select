<!DOCTYPE html>
<html>
	<meta charset="utf-8">
	<head>
		<link rel="stylesheet" href="../../build/css/tom-select.bootstrap5.css">
		<script src="../../build/js/tom-select.base.js"></script>
	</head>
	<body>
		<div style="margin:3rem auto;width:50vw">
			<select id="reddit-search" placeholder="Search Reddit ..." multiple></select>	</body>
		</div>
	<script>


	TomSelect.define('virtual_scroll',function(options) {
		const self						= this;
		const pagination				= {};
		const orig_canLoad				= self.canLoad;
		const orig_clearActiveOption	= self.clearActiveOption;
		const orig_loadCallback			= self.loadCallback;
		var dropdown_content;
		var loading_more				= false;


		if( !self.settings.firstUrl ){
			throw 'virtual_scroll plugin requires a firstUrl() method';
			return;
		}


		// in order for virtual scrolling to work,
		// options need to be ordered the same way they're returned from the remote data source
		self.settings.sortField			= [{field:'$order'},{field:'$score'}];


		// can we load more results for given query?
		function canLoadMore(query){

			if( typeof self.settings.maxOptions === 'number' && dropdown_content.children.length >= self.settings.maxOptions ){
				return;
			}

			if( (query in pagination) && pagination[query].length > 0 ){
				return true;
			}

			return false;
		}


		// set the next url that will be
		self.setNextUrl = function(value,next_url){
			pagination[value] = pagination[value] || [];
			pagination[value].push(next_url);
		};

		// getUrl() to be used in settings.load()
		self.getUrl = function(query){

			if( query in pagination ){
				return pagination[query].shift();
			}

			return self.settings.firstUrl(query);;
		};

		// don't clear the active option (and cause unwanted dropdown scroll)
		// while loading more results
		self.hook('instead','clearActiveOption',()=>{

			if( loading_more ){
				return;
			}

			return orig_clearActiveOption.call(self);
		});

		// override the canLoad method
		self.hook('instead','canLoad',(query)=>{

			// first time the query has been seen
			if( !(query in pagination) ){
				return orig_canLoad.call(this,query);
			}

			return canLoadMore(query);
		});


		// wrap the load
		self.hook('instead','loadCallback',(value, options, optgroups)=>{

			if( !loading_more ){
				self.clearOptions();
			}

			orig_loadCallback.call( self, value, options, optgroups);

			loading_more = false;
		});


		// add templates to dropdown
		//	loading_more if we have another url in the queue
		//	no_more_results if we don't have another url in the queue
		self.hook('after','refreshOptions',()=>{

			const query		= self.lastValue;

			if( canLoadMore(query) ){
				var option = self.render('loading_more',{query:query});
				option.setAttribute('data-selectable',''); // so that navigating dropdown with [down] keypresses can navigate to this node
				option.classList.add(self.settings.optionClass);
				dropdown_content.append( option );

			}else if( (query in pagination) && !dropdown_content.querySelector('.no-results') ){
				dropdown_content.append( self.render('no_more_results',{query:query}) );
			}

		});


		// add scroll listener and default templates
		self.hook('after','setup',()=>{
			dropdown_content = self.dropdown_content;

			// default templates
			self.settings.render = Object.assign({}, {
				loading_more:function(data,escape){
					return `<div>Loading more results ... </div>`;
				},
				no_more_results:function(data,escape){
					return '<div>No more results</div>';
				}
			},self.settings.render);


			// watch dropdown content scroll position
			dropdown_content.addEventListener('scroll',function(){

				const scroll_percent = dropdown_content.clientHeight / (dropdown_content.scrollHeight - dropdown_content.scrollTop);
				if( scroll_percent < 0.95 ){
					return;
				}

				// !important: this will get checked again in load() but we still need to check here otherwise loading_more will be set to true
				if( !canLoadMore(self.lastValue) ){
					return;
				}

				// don't call load() too much
				if( loading_more ) return;


				loading_more = true;
				self.load.call(self,self.lastValue);
			});
		});

	});

	class TestSelect extends TomSelect{
		close(){}
	}

	new TestSelect('#reddit-search',{
		valueField: 'permalink',
		labelField: 'title',
		searchField: ['title'],
		plugins:['virtual_scroll'],
		maxOptions: 200,

		// fetch remote data
		firstUrl: function(query){
			return 'https://api.reddit.com/search?q=' + encodeURIComponent(query);
		},
		load: function(query, callback) {

			const url = this.getUrl(query);

			fetch(url)
				.then(response => response.json())
				.then(json => {

					// prepare the next url that will be loaded when the dropdown is scrolled to the bottom
					// !! set before invoking callback()
					const next_url = 'https://api.reddit.com/search?q=' + encodeURIComponent(query)+'&after='+json.data.after;
					this.setNextUrl(query, next_url);

					// add data to the results
					let data = json.data.children.map(row => row.data);
					callback(data);

				}).catch((e)=>{
					callback();
				});

		},
		render: {
			option: function(data, escape) {
				return `<div>${ escape(data.$order) } - ${ escape(data.title) }</div>`;
			},
			loading_more:function(data,escape){
				return `<div>Loading more custom ... </div>`;
			}
		},
	});


	</script>
</html>
